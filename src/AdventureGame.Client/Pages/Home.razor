@page "/"
@using System.Text.Json
@using AdventureGame.Shared
@inject HttpClient Http
@inject IJSRuntime JS
@implements IDisposable

<div class="game-container">
    <h1 class="game-title">Quest</h1>
    <p class="game-subtitle">An AI-Powered Adventure</p>

    @if (_state == GameState.Start)
    {
        <div class="start-screen">
            <p>Enter a theme for your adventure, or leave blank for a surprise.</p>
            <input class="theme-input"
                   @bind="_theme"
                   @bind:event="oninput"
                   placeholder="e.g. haunted castle, space station, pirate ship..."
                   @onkeydown="OnThemeKeyDown" />
            <br />
            <button class="btn-start" @onclick="StartGame" disabled="@_isLoading">
                Begin Adventure
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="error-message">@_error</div>
    }

    @if (_state == GameState.Playing || _state == GameState.GameOver)
    {
        @foreach (var entry in _history)
        {
            <div class="history-scene">
                <div class="scene-card">
                    @if (!string.IsNullOrEmpty(entry.Scene.ImageUrl))
                    {
                        <img class="scene-image" src="@entry.Scene.ImageUrl" alt="Scene illustration" />
                    }
                    <span class="scene-description">@entry.Scene.Description</span>
                </div>
                @if (entry.ChosenAction is not null)
                {
                    <div class="history-action">You chose: @entry.ChosenAction</div>
                }
            </div>
        }

        @* Streaming text / current scene *@
        @if (_isStreaming && !string.IsNullOrEmpty(_streamingDescription))
        {
            <div class="scene-card">
                <div class="scene-description streaming">@_streamingDescription<span class="cursor">|</span></div>
            </div>
            <div class="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">The story unfolds...</div>
            </div>
        }
        else if (_isStreaming && string.IsNullOrEmpty(_streamingDescription))
        {
            <div class="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">The Game Master is crafting your fate...</div>
            </div>
        }
        else if (_currentScene is not null)
        {
            <div class="scene-card">
                @if (!string.IsNullOrEmpty(_currentScene.ImageUrl))
                {
                    <img class="scene-image" src="@_currentScene.ImageUrl" alt="Scene illustration" />
                }
                else if (_isLoadingImage)
                {
                    <div class="scene-image-placeholder">
                        <div class="loading-spinner"></div>
                    </div>
                }
                <span class="scene-description">@_currentScene.Description</span>
            </div>

            @if (_currentScene.IsGameOver)
            {
                <div class="game-over">
                    <div class="game-over-text">The adventure has ended.</div>
                    <button class="btn-start" @onclick="Reset">Play Again</button>
                </div>
            }
            else if (!_isLoading)
            {
                <div class="actions-header">What do you do?</div>
                <div class="action-list">
                    @foreach (var action in _currentScene.Actions)
                    {
                        <button class="btn-action"
                                @onclick="() => ChooseAction(action)"
                                disabled="@_isLoading">
                            <span class="action-number">@action.Id.</span> @action.Text
                        </button>
                    }
                </div>
                <div id="actions-end"></div>
            }
        }
    }
    else if (_state == GameState.Loading)
    {
        <div class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">The Game Master is crafting your fate...</div>
        </div>
    }
</div>

@code {
    private enum GameState { Start, Loading, Playing, GameOver }

    private GameState _state = GameState.Start;
    private string? _theme;
    private string? _gameId;
    private GameScene? _currentScene;
    private bool _isLoading;
    private bool _isStreaming;
    private bool _isLoadingImage;
    private string _streamingDescription = "";
    private string? _error;
    private readonly List<HistoryEntry> _history = [];
    private DotNetObjectReference<Home>? _dotNetRef;
    private TaskCompletionSource? _streamTcs;
    private bool _scrollToActions;

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private record HistoryEntry(GameScene Scene, string? ChosenAction);

    protected override void OnInitialized()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_scrollToActions)
        {
            _scrollToActions = false;
            await JS.InvokeVoidAsync("scrollToElement", "actions-end");
        }
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    private async Task OnThemeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await StartGame();
    }

    private async Task StartGame()
    {
        _error = null;
        _state = GameState.Playing;
        _isLoading = true;
        _isStreaming = true;
        _streamingDescription = "";
        _currentScene = null;
        _history.Clear();

        try
        {
            var body = JsonSerializer.Serialize(new StartGameRequest { Theme = _theme });
            var baseUri = Http.BaseAddress?.ToString().TrimEnd('/') ?? "";
            var url = $"{baseUri}/api/game/start/stream";

            _streamTcs = new TaskCompletionSource();
            await JS.InvokeVoidAsync("sseInterop.fetchSse", url, body, _dotNetRef);
            await _streamTcs.Task;
        }
        catch (Exception ex)
        {
            _error = $"Failed to start game: {ex.Message}";
            _state = GameState.Start;
            _isStreaming = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ChooseAction(GameAction action)
    {
        if (_gameId is null || _currentScene is null) return;

        _error = null;
        _isLoading = true;
        _isStreaming = true;
        _streamingDescription = "";

        // Move current scene to history
        _history.Add(new HistoryEntry(_currentScene, action.Text));
        _currentScene = null;

        try
        {
            var body = JsonSerializer.Serialize(new ChooseActionRequest { GameId = _gameId, ActionId = action.Id });
            var baseUri = Http.BaseAddress?.ToString().TrimEnd('/') ?? "";
            var url = $"{baseUri}/api/game/action/stream";

            _streamTcs = new TaskCompletionSource();
            await JS.InvokeVoidAsync("sseInterop.fetchSse", url, body, _dotNetRef);
            await _streamTcs.Task;
        }
        catch (Exception ex)
        {
            _error = $"Failed to process action: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnSseEvent(string eventType, string data)
    {
        var streamEvent = JsonSerializer.Deserialize<StreamEvent>(data, JsonOptions);
        if (streamEvent is null) return;

        switch (eventType)
        {
            case "text":
                _streamingDescription += streamEvent.Data;
                _gameId ??= streamEvent.GameId;
                InvokeAsync(StateHasChanged);
                break;

            case "scene":
                _isStreaming = false;
                _isLoading = false;
                _isLoadingImage = true;
                var scene = JsonSerializer.Deserialize<GameScene>(streamEvent.Data, JsonOptions);
                if (scene is not null)
                {
                    _gameId = streamEvent.GameId;
                    _currentScene = scene;
                    _state = scene.IsGameOver ? GameState.GameOver : GameState.Playing;
                    _scrollToActions = !scene.IsGameOver;
                }
                _streamingDescription = "";
                InvokeAsync(StateHasChanged);
                break;

            case "image":
                if (_currentScene is not null)
                {
                    _currentScene = _currentScene with { ImageUrl = streamEvent.Data };
                }
                _isLoadingImage = false;
                InvokeAsync(StateHasChanged);
                break;
        }
    }

    [JSInvokable]
    public void OnSseComplete()
    {
        _isStreaming = false;
        _isLoadingImage = false;
        _streamTcs?.TrySetResult();
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnSseError(string errorMessage)
    {
        _error = $"Streaming error: {errorMessage}";
        _isStreaming = false;
        _isLoadingImage = false;
        if (_currentScene is null && _history.Count == 0)
            _state = GameState.Start;
        _streamTcs?.TrySetException(new Exception(errorMessage));
        InvokeAsync(StateHasChanged);
    }

    private void Reset()
    {
        _state = GameState.Start;
        _gameId = null;
        _currentScene = null;
        _theme = null;
        _error = null;
        _isStreaming = false;
        _isLoadingImage = false;
        _streamingDescription = "";
        _history.Clear();
    }
}
